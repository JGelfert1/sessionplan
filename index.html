<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Barcamp — Beispiel-Sessionplan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
      /* Layout */
      body{padding:1.5rem;background:#f8f9fa}
      header{margin-bottom:1rem}
      .session-card{border-left:4px solid var(--bs-primary)}
      .session-card .card-body{padding:.6rem}
      .session-time{font-weight:700;width:110px}
      .tag{font-size:.75rem}
      /* Desktop: table view, Mobile: stacked cards */
      .matrix-view{display:none}
      .stacked-view{display:block}
      @media (min-width: 768px){
        .matrix-view{display:block}
        .stacked-view{display:none}
      }
      /* Table cells: keep consistent heights for cards */
      .matrix-table td{vertical-align:top;padding:.6rem}
      .matrix-table .card{min-height:4.5rem}
      /* Small adjustments */
      .room-badge{font-size:.7rem}
    </style>
  </head>
  <body>
    <header class="container">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
        <div>
          <h1 class="h3 mb-1">Barcamp Ruhr — Beispiel-Sessionplan</h1>
          <p class="text-muted mb-0">Samstag, 10. Januar • Ort: Kulturzentrum</p>
        </div>
        <div class="w-100 w-md-auto d-flex gap-2">
          <select id="planSelect" class="form-select form-select-sm" aria-label="Sessionplan auswählen"></select>
          <div class="input-group">
            <input id="search" type="search" class="form-control" placeholder="Suchen (Titel, Speaker, Tag)" aria-label="Suchen" oninput="filterSessions()">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">Zurücksetzen</button>
          </div>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="mt-3">
        <h2 class="h5">Legend</h2>
        <p class="small text-muted">Ansicht wechselt automatisch: Tabelle für Desktop/Tablet, gestapelte Karten für Smartphones.</p>
      </section>

      <!-- MATRIX VIEW (Desktop / Tablet) -->
      <section class="matrix-view mt-3">
        <div class="table-responsive">
          <table class="table table-bordered matrix-table">
            <thead class="table-light" id="matrixHeader">
              <!-- dynamically populated -->
            </thead>
            <tbody id="matrixBody">
              <!-- dynamically populated -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- STACKED VIEW (Smartphones) -->
      <section class="stacked-view mt-3">
        <div id="stackedList" class="row g-3">
          <!-- dynamically populated -->
        </div>
      </section>

    </main>

    <footer class="container mt-4 mb-4 text-muted small">© Barcamp Beispiel — Diese Seite zeigt nur einen Beispiel-Sessionplan.</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
      // Plans available in data/template — keep in sync with files created
      const PLANS = [
        {name: 'Barcamp Beispiel A', file: 'data/template/BASIC_BARCAMP.json'},
        {name: 'Barcamp Beispiel B — Kompakt', file: 'data/template/TWO_ROOMS_BARCAMP.json'},
        {name: 'Remote Barcamp — Online', file: 'data/template/REMOTE_BARCAMP.json'}
      ];

      // Populate plan select and load selected plan
      document.addEventListener('DOMContentLoaded', ()=>{
        const sel = document.getElementById('planSelect');
        PLANS.forEach((p, i)=>{
          const opt = document.createElement('option');
          opt.value = p.file;
          opt.textContent = p.name;
          if(i===0) opt.selected = true;
          sel.appendChild(opt);
        });
        sel.addEventListener('change', ()=> loadPlan(sel.value));
        // load default
        if(sel.value) loadPlan(sel.value);
      });

      async function loadPlan(url){
        try{
          const res = await fetch(url);
          if(!res.ok) throw new Error('Fehler beim Laden: '+res.status);
          const data = await res.json();
          renderPlan(data);
        }catch(e){
          console.error(e);
          alert('Fehler beim Laden des Plans. Konsole prüfen.');
        }
      }

      function renderPlan(data){
        // header
        const titleEl = document.querySelector('header h1');
        const metaEl = document.querySelector('header p');
        if(data.meta){
          titleEl.textContent = data.meta.title;
          metaEl.textContent = (data.meta.date || '') + (data.meta.location ? ' • Ort: ' + data.meta.location : '');
        }

        const rooms = data.rooms || [];
        const slots = data.slots || [];

        // MATRIX HEADER
        const header = document.getElementById('matrixHeader');
        header.innerHTML = '';
        const headRow = document.createElement('tr');
        headRow.innerHTML = '<th scope="col">Zeit</th>' + rooms.map(r=>`<th scope="col">${escapeHtml(r)}</th>`).join('');
        header.appendChild(headRow);

        // MATRIX BODY
        const body = document.getElementById('matrixBody');
        body.innerHTML = '';
        slots.forEach(slot=>{
          const tr = document.createElement('tr');
          tr.setAttribute('data-time', slot.time || '');
          const timeTd = document.createElement('td');
          timeTd.className = 'session-time align-middle';
          timeTd.textContent = slot.time || '';
          tr.appendChild(timeTd);

          if(slot.full_span || (slot.cells && slot.cells.all)){
            const td = document.createElement('td');
            td.setAttribute('colspan', Math.max(rooms.length, 1));
            const cell = (slot.cells && (slot.cells.all || slot.cells['all'])) || {};
            td.innerHTML = buildCardHtml(cell.title || '', cell.speaker || '', (cell.tags||[]).join(','), cell.badge);
            tr.appendChild(td);
          }else{
            rooms.forEach(r=>{
              const td = document.createElement('td');
              const cell = (slot.cells && slot.cells[r]);
              if(cell){
                td.innerHTML = buildCardHtml(cell.title || '', cell.speaker || '', (cell.tags||[]).join(','));
              }
              tr.appendChild(td);
            });
          }

          body.appendChild(tr);
        });

        // STACKED VIEW
        const stacked = document.getElementById('stackedList');
        stacked.innerHTML = '';
        slots.forEach(slot=>{
          const col = document.createElement('div');
          col.className = 'col-12';
          const heading = document.createElement('div');
          heading.className = 'h6 mb-2';
          heading.textContent = slot.time || '';
          col.appendChild(heading);

          if(slot.full_span || (slot.cells && slot.cells.all)){
            const cell = (slot.cells && (slot.cells.all || slot.cells['all'])) || {};
            const card = document.createElement('div');
            card.className = 'card session-card mb-2';
            card.setAttribute('data-title', cell.title || '');
            card.setAttribute('data-speaker', cell.speaker || '');
            card.setAttribute('data-tags', (cell.tags||[]).join(','));
            card.innerHTML = `<div class="card-body d-flex justify-content-between align-items-center">`+
                             `<div><strong>${escapeHtml(cell.title||'')}</strong><div class="text-muted small">${escapeHtml(cell.speaker||'')}</div></div>`+
                             `${cell.badge?`<span class="badge bg-success room-badge">${escapeHtml(cell.badge)}</span>`:''}`+
                             `</div>`;
            col.appendChild(card);
          }else{
            rooms.forEach(r=>{
              const cell = slot.cells && slot.cells[r];
              if(cell){
                const card = document.createElement('div');
                card.className = 'card session-card mb-2';
                card.setAttribute('data-title', cell.title || '');
                card.setAttribute('data-speaker', cell.speaker || '');
                card.setAttribute('data-tags', (cell.tags||[]).join(','));
                card.innerHTML = `<div class="card-body d-flex justify-content-between">`+
                                 `<div><strong>${escapeHtml(cell.title||'')}</strong><div class="text-muted small">${escapeHtml(cell.speaker||'')} — ${escapeHtml(r)}</div></div>`+
                                 `<span class="badge bg-secondary room-badge">${escapeHtml(r)}</span>`+
                                 `</div>`;
                col.appendChild(card);
              }
            });
          }

          stacked.appendChild(col);
        });

        // ensure search filtering applies to newly created elements
        filterSessions();
      }

      function buildCardHtml(title, speaker, tags, badge){
        return `<article class="card session-card" data-title="${escapeHtml(title)}" data-speaker="${escapeHtml(speaker)}" data-tags="${escapeHtml(tags)}"><div class="card-body"><div class="d-flex justify-content-between"><div><strong>${escapeHtml(title)}</strong><div class="text-muted small">${escapeHtml(speaker)}</div></div>${badge?`<span class="badge bg-primary room-badge">${escapeHtml(badge)}</span>`:''}</div></div></article>`;
      }

      // Simple search/filter across session cards
      function filterSessions(){
        const q = document.getElementById('search').value.trim().toLowerCase();
        const cards = document.querySelectorAll('.session-card');
        if(!q){
          cards.forEach(c=>c.style.display='');
          // also show all rows in matrix
          document.querySelectorAll('#matrixBody tr').forEach(r=>r.style.display='');
          return;
        }
        cards.forEach(c=>{
          const title = (c.getAttribute('data-title')||'').toLowerCase();
          const speaker = (c.getAttribute('data-speaker')||'').toLowerCase();
          const tags = (c.getAttribute('data-tags')||'').toLowerCase();
          const match = title.includes(q) || speaker.includes(q) || tags.includes(q);
          c.style.display = match ? '' : 'none';
        });
        // For matrix: hide whole row if all its cells are empty/hidden
        document.querySelectorAll('#matrixBody tr').forEach(row=>{
          const cells = Array.from(row.querySelectorAll('td'));
          const visibleCard = cells.some(td=> td.querySelector('.session-card') && td.querySelector('.session-card').style.display !== 'none');
          row.style.display = visibleCard ? '' : 'none';
        });
      }
      function clearSearch(){
        document.getElementById('search').value='';
        filterSessions();
      }

      // small helper to avoid injection
      function escapeHtml(s){
        return String(s||'').replace(/[&"'<>]/g, c => ({
          '&': '&amp;',
          '"': '&quot;',
          "'": '&#39;',
          '<': '&lt;',
          '>': '&gt;'
        }[c]));
      }
    </script>
  </body>
</html>